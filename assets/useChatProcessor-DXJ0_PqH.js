import{u as U,a as V,b as _,c as W,d as G,r as B,w as H,e as R,f as D,o as j,S as C,g as z,l as A,h as J,p as K}from"./index-DDol1_rx.js";const N=B({});j(R(D,"nicknames"),n=>{const m=n.val()||{};N.value=m,Object.assign(N,m);const d=V();d.messages&&d.messages.length>0&&d.messages.forEach(g=>{if(m[g.uid]){const h=typeof m[g.uid]=="object"?m[g.uid].nick:m[g.uid];g.displayName!==h&&(g.displayName=h)}})});const Q=/^(\d+(?:[\s,]+\d+)+)(?:\s+(.*))?$/,X=/^(\d+)\s+(.+)$/,Y=/^([^\d]+)\s+(\d+)$/,Z=/โอน|ส่ง|สลิป|ยอด|ที่อยู่|ปลายทาง|พร้อม/,ee=/อก|เอว|สะโพก|ยาว|ราคา|เท่าไหร่|เท่าไร|ทไหร|กี่บาท|แบบไหน|ผ้า|สี|ตำหนิ|ไหม|มั้ย|ป่าว|ขอดู|รีวิว|ว่าง|เหลือ|ยังอยู่|ไซส์/,te=/^\s*(\d+)\s*$/,se=/(?:(?:F|f|cf|CF|รับ|เอา)\s*(\d+))|(?:(\d+)\s*(?:F|f|cf|CF|รับ|เอา))/i,ae=/^(\d+)\s*(?:ค่ะ|ครับ|จ้า|จ้ะ|พี่|ป้า|น้า|อา|แม่|น้อง|ฝาก|\/\/)/,ie=/^([^-]+)\s*[-]\s*(\d+)$/,ne=/(?:^|\s)(?:(?:cc|cancel|ยกเลิก|ไม่เอา|หลุด)\s*[-]?\s*(\d+)|(\d+)\s*(?:cc|cancel|ยกเลิก|ไม่เอา|หลุด))/i,re=/(?:^|\s)(?:รับ|เอา|F|f|cf|CF)(?:\s|$)/;function oe(n){return n.replace(/[๐-๙]/g,m=>m.charCodeAt(0)-3664)}const E=C.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,didOpen:n=>{n.addEventListener("mouseenter",C.stopTimer),n.addEventListener("mouseleave",C.resumeTimer)}}),I=new Set;function le(){const n=U(),m=V(),d=_(),g=W(),{queueAudio:h}=G(),$=B(null);function O(){if(!d.currentVideoId)return;const a=R(D,`overlay/${d.currentVideoId}/current_item`);j(a,t=>{const i=t.val();i&&i.id?$.value=i.id:$.value=null})}O(),H(()=>d.currentVideoId,a=>{a&&O()});function P(a){let t=0;for(let i=0;i<a.length;i++)t=a.charCodeAt(i)+((t<<5)-t);return`hsl(${Math.abs(t)%360}, 85%, 75%)`}async function q(a){if(!a.snippet||!a.authorDetails)return;const t=a.snippet.displayMessage||"";if(!t)return;const i=oe(t),o=a.authorDetails.channelId,b=a.authorDetails.displayName,T=a.authorDetails.profileImageUrl||"https://www.gstatic.com/youtube/img/creator/avatars/sample_avatar.png";let y=b;N.value[o]&&(y=typeof N.value[o]=="object"?N.value[o].nick:N.value[o]);const x=g.getPhoneticName(o,y),w=/admin|แอดมิน/i.test(y)||/admin|แอดมิน/i.test(b);let c=null,s=null,L=null,l=null;n.stockSize;let k=null;const M=i.match(Q);if(M){const r=M[1],u=M[2]?M[2].trim():null,e=r.split(/\s+/).map(f=>parseInt(f)).filter(f=>f>0);if(e.length>0){const f=Math.max(...e);if(f>n.stockSize){const p=Math.ceil(f/10)*10;await n.updateStockSize(p)}let v=y,S=o;u&&w&&(v=u,S="multi-proxy-"+Date.now()+"-"+Math.random().toString(36).substr(2,5));for(const p of e)if(!I.has(p)){I.add(p);try{await n.processOrder(p,v,S,"chat",null,"multi-buy")}finally{I.delete(p)}}E.fire({icon:"success",title:`✅ ตัดรหัส ${e.join(", ")} ให้ ${v} แล้ว`}),m.sendMessageToFirebase(d.currentVideoId,{id:a.id,text:t,messageRuns:z(a),authorName:b,displayName:y,phoneticName:x,realName:b,uid:o,avatar:T,color:P(o),isAdmin:w,type:"buy",detectionMethod:"multi-buy",timestamp:new Date(a.snippet.publishedAt).getTime()}),h("success",x,`${t} ... ทั้งหมด ${e.length} รายการ`);return}}const F=i.match(ne);if(F)c="cancel",s=parseInt(F[1]||F[2]),l="regex-cancel";else if(Z.test(i))c="shipping",l="regex-ship";else if(ee.test(i))l="question-skip";else{const r=i.match(te),u=i.match(se),e=i.match(ae),f=i.match(ie),v=i.match(re);let S=w?i.match(X):null,p=w?i.match(Y):null;p?(c="buy",s=parseInt(p[2]),k=p[1].trim(),l="admin-proxy-name-first"):S?(c="buy",s=parseInt(S[1]),k=S[2].trim(),l="admin-proxy-num-first"):r?(c="buy",s=parseInt(r[1]),l="regex-pure"):u?(c="buy",s=parseInt(u[1]||u[2]),l="regex-explicit"):e?(c="buy",s=parseInt(e[1]),l="regex-polite"):f?(c="buy",s=parseInt(f[2]),l="regex-dash"):v&&$.value&&(c="buy",s=parseInt($.value),l="regex-implicit")}if(!c&&!l&&d.isAiCommander,m.sendMessageToFirebase(d.currentVideoId,{id:a.id,text:t,messageRuns:z(a),authorName:b,displayName:y,phoneticName:x,realName:b,uid:o,avatar:T,color:P(o),isAdmin:w,type:c,detectionMethod:l,timestamp:new Date(a.snippet.publishedAt).getTime()}),c==="buy"&&s>0){if(s>n.stockSize){const e=Math.ceil(s/10)*10;await n.updateStockSize(e)}let r=y,u=o;if(k)r=k,u="proxy-"+Date.now()+"-"+Math.random().toString(36).substr(2,5);else if(w){let e=t.replace(s.toString(),"").replace(/f|cf|รับ|เอา|=/gi,"");e=e.replace(/^[^\w\u0E00-\u0E7F]+|[^\w\u0E00-\u0E7F]+$/g,"").trim(),e.length>0?(r=e,u="admin-proxy-"+Date.now()):(r=y,u="admin-proxy-"+Date.now())}try{if(I.has(s))throw new Error("คิวเต็ม/ซ้ำแล้ว");I.add(s);const e=await n.processOrder(s,r,u,"chat",L,l);if(!e.success||e.action!=="claimed"&&e.action!=="queued")throw new Error(e.error||(e.action==="already_owned"?"ซ้ำแล้ว":"เต็มแล้ว/อื่นๆ"));E.fire({icon:"success",title:`✅ ตัดรหัส ${s} ให้ ${r} แล้ว`}),h("success",x,t)}catch(e){e.message&&(e.message.includes("ซ้ำแล้ว")||e.message.includes("เต็มแล้ว"))?A.warn("Order skipped:",e.message):A.error("Order failed:",e),E.fire({icon:"error",title:`❌ ตัดไม่ได้: ${e.message||"เต็มแล้ว"}`}),h("error",x,t)}finally{I.delete(s)}}else if(c==="cancel"&&s>0){const r=n.stockData[s];(w||r&&r.uid===o)&&(await n.processCancel(s),h("cancel",x,t))}else if(c==="shipping"){const r=R(D,`shipping/${d.currentVideoId}/${o}`);J(r,{ready:!0,timestamp:Date.now(),lastMessage:t}).catch(e=>A.error("Shipping update error:",e));const u=R(D,`shipping/${d.currentVideoId}/${o}/history`);K(u,{text:t,timestamp:Date.now(),type:"user"}),h(null,x,t)}else h(null,x,t)}return{processMessage:q}}export{le as useChatProcessor};
